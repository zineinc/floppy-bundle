{% block storage_file_row %}
    {{ form_row(form) }}
    {{ block("storage_file_javascript", form.vars ) }}
{% endblock %}

{% block storage_file_widget %}
    <div id="storage-file-box{{ id }}">
        <div class="error-message"></div>
        {% if data and data.id %}
            <div id="storage-preview-{{ id }}">
                {{ storage_file_preview(data) }}
            </div>
            <input id="{{ id }}-id" type="hidden" value="{{ data.id }}" name="{{ full_name }}[id]" />
        {% else %}
            <div id="storage-preview-{{ id }}"></div>
            <input type="hidden" id="{{ id }}-id" value="" name="{{ full_name }}[id]" />
        {% endif %}
        <input type="hidden" id="{{ id }}-attributes" value="{% if data.attributes.all %}{{ data.attributes.all|json_encode }}{% endif %}" name="{{ full_name }}[attributes]" />

        <span id="storage-file-button-{{ id }}">{{ "upload"|trans }}</span>
        <ul class="storage-file-progress-holder">
            <li id="storage-file-progress-{{id}}">
                <div class="bar"></div>
            </li>
        </ul>
    </div>
{% endblock %}

{% block storage_file_javascript %}
    <script type="text/javascript">
        $(function(){
            if(typeof(plupload) == "undefined") {
                throw "plupload library is missing. You should include plupload script into your layout.";
            }

            if(typeof(StorageFileFormType) == "undefined") {
                throw "StorageFileFormType javascript is missing. You should include this script into your layout.";
            }

            var progress = $("#storage-file-progress-{{id}} .bar");
            var idInput = $("#{{ id }}-id");
            var attributesInput = $("#{{ id }}-attributes");
            var preview = $("#storage-preview-{{ id }}");
            var box = $("#storage-file-box{{ id }}");
            var errorBox = box.find(".error-message");

            var errorMessages = {
                "unsupported-file-type": "{{ "storage.file.error.unsupported_file_type" }}",
                "file-not-found": "{{ "storage.file.error.file_not_found" }}",
                "store-error": "{{ "storage.file.error.store_error" }}",
                "io": "{{ "storage.file.error.io" }}",
                "file-process-error": "{{ "storage.file.error.file_process_error" }}",
                "invalid-checksum": "{{ "storage.file.error.invalid_checksum" }}",
                "access-denied": "{{ "storage.file.error.access_denied" }}"
            };

            var uploader;
            var eventBus = new StorageFileFormType.EventBus();
            var view = new StorageFileFormType.View(eventBus, box, preview, errorBox, attributesInput, idInput, progress);
            var controller = new StorageFileFormType.Controller(eventBus, function(){ uploader.start(); }, view, errorMessages, "{{ url("storageFilePreview") }}");

            uploader = new plupload.Uploader({
                runtimes: 'html5,flash,silverlight,html4',
                flash_swf_url : '{{ swf }}',
                silverlight_xap_url : '{{ xap }}',
                browse_button: 'storage-file-button-{{ id }}',
                container: 'storage-file-box{{ id }}',
                multi_selection: false,
                url: '{{ url }}',
                file_data_name: '{{ file_key }}',
                {# TODO: filters #}
                init: {
                    FilesAdded: function(up, files) {
                        controller.onFileAdded();
                    },

                    UploadProgress: function(up, file) {
                        controller.onProgress(file.percent);
                    },

                    Error: function(up, response) {
                        controller.onError(response.response);
                    },

                    FileUploaded: function(up, file, response) {
                        controller.onSuccess(response.response);
                    }
                }
            });

            uploader.init();
        });
    </script>
{% endblock %}